---
title: "p8105_hw6_zx2424"
author: "Zhaoqianyu Xiong"
date: "2022-11-26"
output: github_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(p8105.datasets)
library(viridis)
library(modelr)
library(mgcv)
library(glmnet)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

set.seed(1)
```

## Problem 2
Import and clean the data.
```{r}
homicide = 
  read_csv("data/homicide-data.csv") %>% 
  janitor::clean_names() %>%
  mutate(city_state = str_c(city, sep = ",", state)) %>%
  mutate(status = ifelse(disposition == "Closed by arrest", "1", "0")) %>%
  mutate(status = as.integer(status)) %>%
  filter(city_state != "Dallas,TX") %>%
  filter(city_state != "Phoenix,AZ") %>%
  filter(city_state != "Kansas City,MO") %>%
  filter(city_state != "Tulsa,AL") %>%
  filter(victim_race == "White" | victim_race == "Black") %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  filter(victim_sex == "Male" | victim_sex == "Female")
```

Fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors for Baltimore, MD. And save the output as R object "Baltimore_fit".
```{r}
Baltimore_df = homicide %>%
  filter(city_state == "Baltimore,MD") %>%
  select(status, victim_race, victim_sex, victim_age)

Baltimore_fit = 
  Baltimore_df %>%
  glm(status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())
```

Apply broom::tidy() to this object.
```{r}
broom::tidy(Baltimore_fit)
```

Obtain the estimate keeping all other variables fixed. The estimated OR for solving homicides comparing male victims to female victims is 0.426.
```{r}
 Baltimore_fit %>%
  broom::tidy() %>%
  select(term, estimate) %>%
  mutate(OR = exp(estimate)) %>%
  filter(term == "victim_sexMale")
```

Obtain the adjusted confidence interval of adjusted odds ratio keeping all other variables fixed. The 95% confidence interval is from 0.32 to 0.56.
```{r}
exp(confint(Baltimore_fit)) 
```

Write a function to get both OR and CI at the same time.
```{r}
OR_and_CI =
  function(fit){
    df_1 = fit %>%
      broom::tidy() %>%
      filter(term == "victim_sexMale")

    df_2 = fit %>%
      confint() %>%
      exp() %>%
      as_tibble() 
    
    tibble(
      OR = exp(df_1$estimate),
      Conf_low = as.numeric(df_2[3,1]),
      Conf_high = as.numeric(df_2[3,2])
    )
      }
```

Run glm for each cities in my dataset. And extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims.
```{r}
all_fit = homicide %>%
  select(city_state, status, victim_race, victim_sex, victim_age) %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(data, ~glm(status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())),
    results = map(models, OR_and_CI)) %>%
  select(-data, -models) %>%
  unnest(results)

all_fit
```

Create a plot that shows the estimated ORs and CIs for each city. From the plot, we can discover that the odds ratios for solving homicides comparing male victims to female victims of most cities are less than 1, it means that the homicides in which male is less likely to be resolved than those in which the victim is female. Although the situation reverses in Fresno, CA; Stockton, CA; Albuquerque, NM, their confidence intervals are extremely wide, which means that the situation differs for different cases.
```{r}
all_fit %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = Conf_low, ymax = Conf_high), width = 0.2) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

## Problem 3
Load and clean the data for regression analysis.
```{r}
birthweight = read_csv("data/birthweight.csv") %>%
  drop_na() %>%
  mutate(babysex = ifelse(babysex == 1, "male", "female"),
         babysex = fct_relevel(babysex, "male"),
         malform = as.character(malform),
         malform = as.factor(malform)) %>%
  select(bwt, everything())
```

Use LASSO to choose predictors. When lamba reach 60, there are only three predictors left to be non-zero, which are "bhead", "blength", and "gaweeks".So I will use these three predictors to fit my regression model.
```{r}
bwt_fit = glmnet(as.matrix(birthweight[2:20]), birthweight$bwt, lambda = 60)
coef(bwt_fit)
```

Make a linear regression model and show a plot of model residuals against fitted values. Although there are some outliers, most points are close to 0 on y-axis.
```{r}
bwt_1 = lm(bwt ~ bhead + blength + gaweeks, data = birthweight)
birthweight %>%
  add_residuals(bwt_1) %>%
  add_predictions(bwt_1) %>%
  ggplot(aes(x = pred, y = resid, color = bwt)) + geom_point()
```




